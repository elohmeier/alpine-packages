package:
  name: pivccu-modules-rpi
  version: 0_git20250128
  epoch: 0
  description: "Pre-built piVCCU kernel modules for linux-rpi"
  copyright:
    - license: GPL-2.0-only
  dependencies:
    runtime:
      - pivccu-detect
  target-architecture:
    - aarch64
  options:
    no-depends: true
  checks:
    disabled:
      - usrmerge
  scriptlets:
    post-install: |
      #!/bin/sh
      echo ""
      echo "=== piVCCU Kernel Modules Installed ==="
      echo ""
      echo "Modules installed to /usr/share/pivccu-modules/"
      echo "  - generic_raw_uart: Core raw UART framework"
      echo "  - eq3_char_loop: eQ-3 character device loop"
      echo "  - hb_rf_usb_2: USB support (HmIP-RFUSB, HB-RF-USB-2)"
      echo "  - pl011_raw_uart: PL011 UART support (RPi GPIO)"
      echo "  - rpi_rf_mod_led: RPI-RF-MOD LED control"
      echo ""
      echo "Modules will be auto-loaded via /etc/modules-load.d/pivccu.conf"
      echo "udev rules installed to /etc/udev/rules.d/99-pivccu.rules"
      echo ""
      # Copy dtbo to SD card if mounted
      if [ -d /media/mmcblk0p1/overlays ]; then
        cp /boot/overlays/pivccu-raspberrypi.dtbo /media/mmcblk0p1/overlays/
        echo "Device tree overlay copied to /media/mmcblk0p1/overlays/"
        echo "Add 'dtoverlay=pivccu-raspberrypi' to /media/mmcblk0p1/usercfg.txt"
      else
        echo "Device tree overlay installed to /boot/overlays/"
        echo "For diskless boot, copy to your boot partition"
      fi
      echo ""

environment:
  contents:
    repositories:
      - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
      - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
    keyring:
      - https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-4a6a0840.rsa.pub
    packages:
      - busybox
      - ca-certificates
      - build-base
      - git
      - dtc
      - linux-rpi-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/alexreinert/piVCCU.git
      branch: master
      expected-commit: c34c4204b76fb4ebb1868853be63b2271d1a7983

  - runs: |
      DESTDIR="${{targets.destdir}}"
      SRCROOT="$(pwd)"

      # Find the kernel version from linux-rpi-dev
      KVER=$(ls /lib/modules/ | head -1)
      echo "Building modules for kernel: $KVER"

      # Prepare build directory
      cd kernel

      # Apply kernel compatibility patches
      # Patch for Linux 6.12+: no_llseek removed, use noop_llseek
      sed -i 's/\.llseek = no_llseek/.llseek = noop_llseek/g' generic_raw_uart.c
      sed -i 's/\.llseek = no_llseek/.llseek = noop_llseek/g' eq3_char_loop.c

      # Build the kernel modules
      make KERNEL_DIR="/lib/modules/$KVER/build" all

      # Install modules to /usr/share for diskless compatibility
      mkdir -p "$DESTDIR/usr/share/pivccu-modules"
      cp generic_raw_uart.ko "$DESTDIR/usr/share/pivccu-modules/"
      cp eq3_char_loop.ko "$DESTDIR/usr/share/pivccu-modules/"
      cp hb_rf_usb_2.ko "$DESTDIR/usr/share/pivccu-modules/"
      cp pl011_raw_uart.ko "$DESTDIR/usr/share/pivccu-modules/"
      cp rpi_rf_mod_led.ko "$DESTDIR/usr/share/pivccu-modules/"

      # Install module loading config
      mkdir -p "$DESTDIR/etc/modules-load.d"
      cat > "$DESTDIR/etc/modules-load.d/pivccu.conf" << 'EOF'
      # piVCCU kernel modules for HomeMatic RF hardware
      generic_raw_uart
      eq3_char_loop
      hb_rf_usb_2
      EOF
      # Remove leading whitespace from pivccu.conf
      sed -i 's/^      //' "$DESTDIR/etc/modules-load.d/pivccu.conf"

      # Install udev rules for Homematic USB devices
      mkdir -p "$DESTDIR/etc/udev/rules.d"
      cat > "$DESTDIR/etc/udev/rules.d/99-pivccu.rules" << 'EOF'
      # piVCCU udev rules for HomeMatic RF hardware
      # HmIP-RFUSB
      ATTRS{idVendor}=="1b1f", ATTRS{idProduct}=="c020", ENV{ID_MM_DEVICE_IGNORE}="1"
      # HM-CFG-USB-2
      ATTRS{idVendor}=="1b1f", ATTRS{idProduct}=="c00f", ENV{ID_MM_DEVICE_IGNORE}="1"
      # HB-RF-USB / HB-RF-USB-2
      ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6f70", ENV{ID_MM_DEVICE_IGNORE}="1"
      ATTRS{idVendor}=="10c4", ATTRS{idProduct}=="8c07", ENV{ID_MM_DEVICE_IGNORE}="1"
      EOF
      sed -i 's/^      //' "$DESTDIR/etc/udev/rules.d/99-pivccu.rules"

      # Compile and install device tree overlay
      mkdir -p "$DESTDIR/boot/overlays"
      dtc -@ -I dts -O dtb -o "$DESTDIR/boot/overlays/pivccu-raspberrypi.dtbo" \
          "$SRCROOT/dts/pivccu-raspberrypi.dts"

test:
  environment:
    contents:
      repositories:
        - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
        - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
      keyring:
        - https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-4a6a0840.rsa.pub
      packages:
        - busybox
  pipeline:
    - runs: |
        # Test that module files exist
        test -f /usr/share/pivccu-modules/generic_raw_uart.ko
        test -f /usr/share/pivccu-modules/eq3_char_loop.ko
        test -f /usr/share/pivccu-modules/hb_rf_usb_2.ko
        test -f /usr/share/pivccu-modules/pl011_raw_uart.ko
        test -f /usr/share/pivccu-modules/rpi_rf_mod_led.ko

        # Test modules-load.d config
        test -f /etc/modules-load.d/pivccu.conf
        grep -q "generic_raw_uart" /etc/modules-load.d/pivccu.conf
        grep -q "eq3_char_loop" /etc/modules-load.d/pivccu.conf
        grep -q "hb_rf_usb_2" /etc/modules-load.d/pivccu.conf

        # Test udev rules
        test -f /etc/udev/rules.d/99-pivccu.rules
        grep -q "1b1f.*c020" /etc/udev/rules.d/99-pivccu.rules

        # Test device tree overlay exists
        test -f /boot/overlays/pivccu-raspberrypi.dtbo

        echo "pivccu-modules-rpi tests passed!"
