package:
  name: chip-sdk
  version: 2025.7.0
  epoch: 0
  description: "Matter/CHIP SDK Python bindings for Home Assistant"
  copyright:
    - license: Apache-2.0
  options:
    # Disable auto-detection which adds Wolfi-style python-3.12-base
    no-depends: true
  dependencies:
    runtime:
      - python3
      - libuv
      - zlib
      - json-c
      - libnl3
      - glib
      - dbus-libs
      - libssl3
      - libcrypto3
      - libgcc
      - libstdc++
  target-architecture:
    - x86_64
    - aarch64
  checks:
    disabled:
      - usrmerge

environment:
  contents:
    repositories:
      - https://dl-cdn.alpinelinux.org/alpine/edge/main
      - https://dl-cdn.alpinelinux.org/alpine/edge/community
    keyring:
      - https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-4a6a0840.rsa.pub
    packages:
      - busybox
      - ca-certificates
      - build-base
      - git
      - gn
      - ninja
      - python3
      - python3-dev
      - py3-pip
      - py3-setuptools
      - py3-wheel
      - py3-virtualenv
      - patch
      - openssl-dev
      - glib-dev
      - libnl3-dev
      - dbus-dev
      - readline-dev
      - libffi-dev
      - yaml-dev
      - unzip
      - zstd
      - wget
      - nodejs
      - zap-cli
      - ccache
  environment:
    PIP_CACHE_DIR: /var/cache/melange/pip
    CCACHE_DIR: /var/cache/melange/ccache
    # Skip CIPD in Pigweed - use system tools instead
    PW_ENVSETUP_NO_CIPD: "1"

pipeline:
  # Clone connectedhomeip and checkout submodules
  - runs: |
      # Clone chip-wheels at the matching tag to get correct connectedhomeip commit
      git clone --depth 1 --branch "${{package.version}}" \
        https://github.com/home-assistant-libs/chip-wheels.git chip-wheels

      cd chip-wheels

      # Initialize connectedhomeip submodule
      git submodule update --init --depth 1 connectedhomeip

      cd connectedhomeip

      # Checkout required submodules for linux platform
      python3 scripts/checkout_submodules.py --shallow --platform linux

  # Apply patches from chip-wheels
  - runs: |
      cd chip-wheels/connectedhomeip
      for patch in ../*.patch; do
        echo "Applying $patch"
        patch -p1 < "$patch"
      done

  # Set up Python build environment
  - runs: |
      cd chip-wheels/connectedhomeip

      # Install Python build requirements
      python3 -m pip install --break-system-packages \
        click coloredlogs jinja2 lark python-path lxml \
        pip-tools virtualenv wheel build mypy mypy-protobuf protobuf \
        cffi cryptography ecdsa

  # Create minimal Pigweed environment (skip CIPD bootstrap)
  - runs: |
      cd chip-wheels/connectedhomeip

      # Initialize pigweed submodule if needed
      git submodule update --init third_party/pigweed/repo

      # Create empty pigweed_environment.gni (required by build system)
      # This is what the configure script does to avoid full Pigweed bootstrap
      echo "# Auto-generated by melange build" > build_overrides/pigweed_environment.gni

      # Set PW_PROJECT_ROOT for pip requirements that reference it
      export PW_PROJECT_ROOT="$(pwd)"

      # Install Pigweed Python packages
      python3 -m pip install --break-system-packages \
        -r scripts/setup/requirements.build.txt

  # Build Python wheels
  - runs: |
      cd chip-wheels/connectedhomeip

      # Set up environment
      export PW_PROJECT_ROOT="$(pwd)"
      export PW_ROOT="$(pwd)/third_party/pigweed/repo"

      # Determine CPU tag
      case "${{build.arch}}" in
        x86_64) _cpu="x86_64" ;;
        aarch64) _cpu="aarch64" ;;
      esac

      # Generate build files with GN
      # Use custom toolchain with native compilers (no cross-compile prefix)
      # Use ccache to speed up rebuilds
      gn gen out/python --args="
        custom_toolchain=\"//build/toolchain/custom\"
        target_cc=\"ccache gcc\"
        target_cxx=\"ccache g++\"
        target_ar=\"ar\"
        chip_crypto=\"openssl\"
        chip_build_tests=false
        enable_rtti=true
        chip_config_memory_debug_checks=false
        chip_config_memory_debug_dmalloc=false
        chip_mdns=\"minimal\"
        chip_minmdns_default_policy=\"libnl\"
        chip_python_version=\"${{package.version}}\"
        chip_python_package_prefix=\"home-assistant-chip\"
        chip_python_platform_tag=\"musllinux_1_2\"
        chip_project_config_include_dirs=[\"//config/python\"]
      "

      # Build Python wheels
      ninja -C out/python python_wheels

      # Show ccache stats for debugging
      ccache -s

  # Install CHIP wheels
  - runs: |
      pyver=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
      sitepkgs="${{targets.destdir}}/usr/lib/python$pyver/site-packages"
      mkdir -p "$sitepkgs"

      # Install CHIP wheels built from source
      # Force install with matching platform tag (pip may reject musllinux wheels)
      for whl in chip-wheels/connectedhomeip/out/python/controller/python/*.whl; do
        echo "Installing $whl"
        # Extract wheel directly to work around pip platform check
        unzip -q -o "$whl" -d "$sitepkgs"
      done
      # Clean up dist-info metadata we don't need
      rm -rf "$sitepkgs"/*.dist-info/direct_url.json 2>/dev/null || true

test:
  environment:
    contents:
      repositories:
        - https://dl-cdn.alpinelinux.org/alpine/edge/main
        - https://dl-cdn.alpinelinux.org/alpine/edge/community
      keyring:
        - https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-4a6a0840.rsa.pub
  pipeline:
    - runs: |
        # Test that chip core module can be imported
        # Note: Full chip module requires 'construct' package (provided by matter-server)
        python3 -c "from chip.exceptions import ChipStackError; print('chip.exceptions OK')"
    - runs: |
        # Test that the native .so library exists
        find /usr/lib -name "_ChipDeviceCtrl*.so" | grep -q . && echo "native library OK"
