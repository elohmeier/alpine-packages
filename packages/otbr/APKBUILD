# Contributor: Enno Lohmeier <enno@elohmeier.de>
# Maintainer: Enno Lohmeier <enno@elohmeier.de>
pkgname=otbr
pkgver=0.3.0
pkgrel=0
_gittag="thread-reference-20250612"
pkgdesc="OpenThread Border Router"
url="https://github.com/openthread/ot-br-posix"
arch="aarch64 x86_64"
license="BSD-3-Clause"
depends="iptables ipset jsoncpp eudev avahi"
makedepends="cmake ninja jsoncpp-dev linux-headers git avahi-dev"
install="$pkgname.pre-install"
options="!check"  # no test suite
source="
	otbr-agent.initd
	otbr-agent.confd
	99-otbr.rules
	"

fetch() {
	if [ ! -d "$srcdir/$pkgname-$pkgver" ]; then
		mkdir -p "$srcdir"
		git clone --depth 1 --branch "$_gittag" --recursive \
			https://github.com/openthread/ot-br-posix.git "$srcdir/$pkgname-$pkgver"
	fi
}

unpack() {
	# Copy local source files to srcdir
	for src in $source; do
		case "$src" in
			*.initd|*.confd|*.rules)
				cp "$startdir/$src" "$srcdir/"
				;;
		esac
	done
}

build() {
	cd "$srcdir/$pkgname-$pkgver"
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=Release \
		-DBUILD_TESTING=OFF \
		-DOTBR_DBUS=OFF \
		-DOTBR_MDNS=avahi \
		-DOTBR_REST=OFF \
		-DOTBR_WEB=OFF \
		-DOTBR_NAT64=ON \
		-DOTBR_BORDER_ROUTING=ON
	cmake --build build
}

package() {
	cd "$srcdir/$pkgname-$pkgver"
	DESTDIR="$pkgdir" cmake --install build

	install -Dm755 "$srcdir"/otbr-agent.initd \
		"$pkgdir"/etc/init.d/otbr-agent
	install -Dm644 "$srcdir"/otbr-agent.confd \
		"$pkgdir"/etc/conf.d/otbr-agent
	install -Dm644 "$srcdir"/99-otbr.rules \
		"$pkgdir"/etc/udev/rules.d/99-otbr.rules
}

sha512sums="
63f43e5282f53ead7cfe1737fbd87f97a8dddcb5dc0d234cc701a851f644feb90cd762704a5ac56ce135e0f301247e052b038fe3fcdafa5f3f1a406cf402c2b2  otbr-agent.initd
a78914bc2c328965ecb0d2027e5b603a42a1f7df7e8f5662b287d3390b8c9d1881ecca9172007a8093423effb8cdef8da8875bdcf33c17c662527a9d7e0371f9  otbr-agent.confd
ec8d692a8a5ed428c02eb87a34b281fc8e5e35fee01cef0d5fb48922dc6d251bc3fcc565b43467622817d70c2691a9b69219bf97194874dcfa390bda6779689a  99-otbr.rules
"
