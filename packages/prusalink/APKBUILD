# Contributor: PrusaLink Developers <link@prusa3d.cz>
# Maintainer: PrusaLink Developers <link@prusa3d.cz>
pkgname=prusalink
pkgver=0.8.1
pkgrel=8
install="$pkgname.pre-install $pkgname.post-install"
pkgdesc="Web interface and REST API for Prusa 3D printers with PrusaConnect integration"
url="https://github.com/prusa3d/Prusa-Link"
arch="all"
license="Freeware"
depends="
	python3
	py3-numpy
	libjpeg-turbo
	libturbojpeg
	libcap2
	libmagic
	eudev
	eudev-libs
	yaml
	"
makedepends="
	py3-pip
	py3-setuptools
	py3-wheel
	py3-numpy
	python3-dev
	libjpeg-turbo-dev
	libcap-dev
	linux-headers
	libffi-dev
	yaml-dev
	"
# OpenRC files included in main package
source="
	https://files.pythonhosted.org/packages/source/p/prusalink/prusalink-$pkgver.tar.gz
	prusalink.initd
	prusalink.confd
	prusalink.ini
	prusalink.pre-install
	prusalink.post-install
	99-prusalink.rules
	"
options="!check net"  # Tests require hardware; net needed for pip

# Pin pydantic to 1.x as prusalink is not compatible with 2.x
_pydantic_version="1.10.12"

build() {
	# Create a wheel for prusalink
	python3 -m pip wheel --no-deps --wheel-dir .dist .

	# Download and build all dependencies into wheels
	# Note: numpy is excluded - use system py3-numpy package instead (much faster on ARM)
	# Use --no-binary for packages that incorrectly download armv7 wheels on armv6
	python3 -m pip wheel \
		--wheel-dir .dist \
		--no-binary charset_normalizer,zeroconf \
		"pydantic==$_pydantic_version" \
		"prusa.connect.sdk.printer>=0.8.1" \
		"py-gcode-metadata" \
		"bidict~=0.22.1" \
		"extendparser~=0.3.1" \
		"jinja2-template-info~=0.2.4" \
		"lockfile~=0.12.2" \
		"packaging~=23.0" \
		"PoorWSGI~=2.5.0" \
		"pyric~=0.1.6.3" \
		"python-daemon~=3.0.1" \
		"python-prctl~=1.8.1" \
		"pyudev~=0.24.0" \
		"PyYAML~=6.0" \
		"requests>=2.31.0" \
		"sortedcontainers~=2.4.0" \
		"unidecode~=1.3.6" \
		"validators~=0.20.0" \
		"zeroconf~=0.47.4" \
		"blinker~=1.5" \
		"python-magic~=0.4.27" \
		"Jinja2>=3.0"

	# Build PyTurboJPEG separately without its numpy dependency
	# (numpy is provided by system py3-numpy)
	python3 -m pip wheel --no-deps --wheel-dir .dist "PyTurboJPEG~=1.7.0"
}

package() {
	local pyver=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
	local sitepkgs="$pkgdir/usr/lib/python$pyver/site-packages"

	# Install all wheels (dependencies + prusalink)
	python3 -m pip install \
		--no-deps \
		--no-compile \
		--target "$sitepkgs" \
		.dist/*.whl

	# Byte-compile Python files
	python3 -m compileall -q "$sitepkgs" || true

	# Create bin directory and install entry points
	install -dm755 "$pkgdir"/usr/bin

	# Create prusalink entry point
	cat > "$pkgdir"/usr/bin/prusalink << 'EOF'
#!/usr/bin/python3
import sys
from prusa.link.__main__ import main
sys.exit(main())
EOF
	chmod 755 "$pkgdir"/usr/bin/prusalink

	# Create prusalink-manager entry point
	cat > "$pkgdir"/usr/bin/prusalink-manager << 'EOF'
#!/usr/bin/python3
import sys
from prusa.link.multi_instance.__main__ import main
sys.exit(main())
EOF
	chmod 755 "$pkgdir"/usr/bin/prusalink-manager

	# Install prusalink-boot script from package data
	if [ -f "$sitepkgs/prusa/link/data/prusalink-boot" ]; then
		install -Dm755 "$sitepkgs/prusa/link/data/prusalink-boot" \
			"$pkgdir"/usr/bin/prusalink-boot
	fi

	# Install OpenRC init script
	install -Dm755 "$srcdir"/prusalink.initd "$pkgdir"/etc/init.d/prusalink
	install -Dm644 "$srcdir"/prusalink.confd "$pkgdir"/etc/conf.d/prusalink

	# Create configuration directory and install Alpine-specific config
	install -dm755 "$pkgdir"/etc/prusalink
	install -Dm644 "$srcdir"/prusalink.ini "$pkgdir"/etc/prusalink/prusalink.ini.example

	# Create data directory (ownership set by post-install script)
	# Logs go to syslog, not files - view with: logread | grep prusalink
	install -dm755 "$pkgdir"/var/lib/prusalink
	install -dm755 "$pkgdir"/var/lib/prusalink/gcodes

	# Install udev rules for serial port access
	install -Dm644 "$srcdir"/99-prusalink.rules "$pkgdir"/etc/udev/rules.d/99-prusalink.rules
}

sha512sums="
c4339a0a5f9cb988d03e94ea5d64ec306401333d51a58651450a97acaf4fe401472e4fd4db438582e4d97d69de301c83f5a5be36d54df8614477c3923a0606b7  prusalink-0.8.1.tar.gz
9db1e576c32d0352c7f06e9ae1805e3e9af2db6867d7976df87abe76036590ca981335f5692ea15b9c7d3acc23b5c452b3bb1068fb15d3687a21ea202364bf03  prusalink.initd
2d6eef72808d1af3676c9efe46e923e4e505c1e6490ae24662befade564527e71e68d8ccad28ce8ffaafcc76a0a2c793e617585efe227a2bdd4d9a7272c0342d  prusalink.confd
1ceb1a61b1ba4cc6ccd51d4d9baa7f707f1d6c00c3b03c1ac118f44c4aac8ecbc6d7c54510d86463041b12c2a6bfda50fb9d4c5452d41d2c5dfe4329668e214c  prusalink.ini
5694f50c3a888d7f9bae2dc95595934d34195c6c368cc145245dad9047a3eeadc76d7d96508edec383caaa31cdacf1e7e7fe9ef56fadcc398c727c15bc0d98f7  prusalink.pre-install
43d311d9ae9365945418b5c135d8d90376e0a20294824d63f2e9a534ada17e0871e1cdb1bf0d9bd0dc8ecb210010f222ac2db46377a6ef0c52baf1479d488948  prusalink.post-install
7c76e7a5bab011459496bd242c147355a2f409cbb726ca3918a78081ff65a73e3d38e19fd243693e57d91c7311697a4c545180aa011e92181b94a9a64e740dc1  99-prusalink.rules
"
