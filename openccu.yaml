package:
  name: openccu
  version: 3.85.7
  epoch: 2
  description: "eQ-3 OCCU - HomeMatic CCU Core Components"
  copyright:
    - license: HMSL
      license-path: occu-src/LicenseDE.txt
  dependencies:
    runtime:
      - gcompat-custom
      - tcl
      - pivccu-detect
  target-architecture:
    - aarch64
    - x86_64
  options:
    no-depends: true
  checks:
    disabled:
      - usrmerge
  scriptlets:
    pre-install: |
      #!/bin/sh
      addgroup -S hm 2>/dev/null || true
      addgroup -S dialout 2>/dev/null || true
      addgroup -S status 2>/dev/null || true
      adduser -S -D -H -h /var/lib/occu -s /sbin/nologin -G status \
        -g "hss_led user" hssled 2>/dev/null || true
      adduser -S -D -H -h /var/lib/occu -s /sbin/nologin \
        -g "ssdpd user" ssdp 2>/dev/null || true
    post-install: |
      #!/bin/sh
      # Create required directories
      mkdir -p /etc/config/crRFD/data
      mkdir -p /var/lib/occu/measurement
      mkdir -p /var/tmp /var/lock
      # Directories required by ReGaHss
      mkdir -p /etc/occu/config/rc.d
      mkdir -p /etc/occu/config/addons/www
      mkdir -p /etc/occu/config/userprofiles

      # Create /boot/VERSION for HMIPServer
      if [ ! -f /boot/VERSION ]; then
        mkdir -p /boot
        echo "3.85.7" > /boot/VERSION
      fi

      # Reload udev rules if udevd is running
      if command -v udevadm >/dev/null 2>&1; then
        udevadm control --reload-rules 2>/dev/null || true
        udevadm trigger 2>/dev/null || true
      fi

      echo ""
      echo "=== OCCU installed ==="
      echo ""
      echo "Quick start:"
      echo "  rc-service occu-hmserver start"
      echo "  rc-update add occu-hmserver default"
      echo ""
      echo "Config files:"
      echo "  /etc/occu/config/crRFD.conf    HmIP adapter (auto-generated)"
      echo "  /etc/occu/config/HMServer.conf HMServer settings"
      echo "  /etc/conf.d/occu-hmserver      Service options"
      echo ""
      echo "Ports:"
      echo "  32010  XML-RPC API (Home Assistant, ioBroker, etc.)"
      echo ""
      echo "Logs:"
      echo "  /var/log/occu-hmserver.log"
      echo ""
      echo "Hardware:"
      echo "  HmIP-RFUSB: plug-and-play, auto-detected"
      echo "  RPI-RF-MOD: requires kernel modules (see github.com/alexreinert/piVCCU)"
      echo ""

environment:
  contents:
    repositories:
      - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
      - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
    keyring:
      - https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-4a6a0840.rsa.pub
    packages:
      - busybox
      - ca-certificates
      - curl
      - git
      - build-base
      - tcl-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/OpenCCU/occu.git
      tag: 3.85.7-2
      destination: occu-src

  # Fetch GLIBC C++ runtime libraries from Debian (for ReGaHss compatibility)
  # ReGaHss requires GLIBC's libstdc++ with compatible RTTI/exception handling
  - runs: |
      ARCH="$(uname -m)"
      mkdir -p glibc-libs

      case "$ARCH" in
        aarch64)
          DEB_ARCH="arm64"
          # Debian bookworm gcc-12 libstdc++6 and libgcc-s1
          # Has all C++20 symbols needed by ReGaHss
          LIBSTDCXX_URL="http://deb.debian.org/debian/pool/main/g/gcc-12/libstdc++6_12.2.0-14+deb12u1_arm64.deb"
          LIBGCC_URL="http://deb.debian.org/debian/pool/main/g/gcc-12/libgcc-s1_12.2.0-14+deb12u1_arm64.deb"
          ;;
        x86_64)
          DEB_ARCH="amd64"
          LIBSTDCXX_URL="http://deb.debian.org/debian/pool/main/g/gcc-12/libstdc++6_12.2.0-14+deb12u1_amd64.deb"
          LIBGCC_URL="http://deb.debian.org/debian/pool/main/g/gcc-12/libgcc-s1_12.2.0-14+deb12u1_amd64.deb"
          ;;
        *)
          echo "Unsupported architecture: $ARCH"
          exit 1
          ;;
      esac

      echo "Downloading GLIBC C++ runtime libraries for $ARCH..."
      cd glibc-libs
      curl -fsSLO "$LIBSTDCXX_URL"
      curl -fsSLO "$LIBGCC_URL"

      # Extract libraries from .deb packages
      # .deb files are ar archives containing data.tar.xz
      for deb in *.deb; do
        ar x "$deb"
        tar xf data.tar.* 2>/dev/null || tar xf data.tar 2>/dev/null
        rm -f control.tar.* data.tar.* debian-binary
      done

      echo "Extracted GLIBC libraries:"
      find . -name "*.so*" -type f

  - runs: |
      cd occu-src

      # Determine architecture
      ARCH="$(uname -m)"
      case "$ARCH" in
        aarch64)
          OCCU_ARCH="aarch64-linux-gnu"
          OCCU_COMMON="arm-gnueabihf-gcc8"
          ;;
        x86_64)
          OCCU_ARCH="x86_64-linux-gnu"
          OCCU_COMMON="X86_32_GCC8"
          ;;
        *)
          echo "Unsupported architecture: $ARCH"
          exit 1
          ;;
      esac

      DESTDIR="${{targets.destdir}}"

      # Create directories
      mkdir -p "$DESTDIR/usr/bin"
      mkdir -p "$DESTDIR/usr/lib"
      mkdir -p "$DESTDIR/etc/occu/config_templates"
      mkdir -p "$DESTDIR/etc/occu/config"
      mkdir -p "$DESTDIR/usr/share/occu/firmware"

      # Install RFD binaries (prefer modern 64-bit if available)
      if [ -d "${OCCU_ARCH}/packages-eQ-3/RFD-Beta/bin" ]; then
        for bin in rfd multimacd crypttool SetInterfaceClock; do
          if [ -f "${OCCU_ARCH}/packages-eQ-3/RFD-Beta/bin/${bin}" ]; then
            install -Dm755 "${OCCU_ARCH}/packages-eQ-3/RFD-Beta/bin/${bin}" "$DESTDIR/usr/bin/${bin}"
          fi
        done
      else
        for bin in rfd multimacd crypttool SetInterfaceClock; do
          if [ -f "${OCCU_COMMON}/packages-eQ-3/RFD/bin/${bin}" ]; then
            install -Dm755 "${OCCU_COMMON}/packages-eQ-3/RFD/bin/${bin}" "$DESTDIR/usr/bin/${bin}"
          fi
        done
      fi

      # Install RFD libraries
      if [ -d "${OCCU_ARCH}/packages-eQ-3/RFD-Beta/lib" ]; then
        for lib in libLanDeviceUtils.so libUnifiedLanComm.so libelvutils.so libhsscomm.so; do
          if [ -f "${OCCU_ARCH}/packages-eQ-3/RFD-Beta/lib/${lib}" ]; then
            install -Dm755 "${OCCU_ARCH}/packages-eQ-3/RFD-Beta/lib/${lib}" "$DESTDIR/usr/lib/${lib}"
          fi
        done
      fi

      # Install XML libraries from WebUI-Beta (required by rfd and other binaries)
      if [ -d "${OCCU_ARCH}/packages-eQ-3/WebUI-Beta/lib" ]; then
        for lib in libxmlparser.so libXmlRpc.so; do
          if [ -f "${OCCU_ARCH}/packages-eQ-3/WebUI-Beta/lib/${lib}" ]; then
            install -Dm755 "${OCCU_ARCH}/packages-eQ-3/WebUI-Beta/lib/${lib}" "$DESTDIR/usr/lib/${lib}"
          fi
        done
      fi

      # Install HS485D binaries
      if [ -d "${OCCU_ARCH}/packages-eQ-3/HS485D-Beta/bin" ]; then
        for bin in hs485d hs485dLoader; do
          if [ -f "${OCCU_ARCH}/packages-eQ-3/HS485D-Beta/bin/${bin}" ]; then
            install -Dm755 "${OCCU_ARCH}/packages-eQ-3/HS485D-Beta/bin/${bin}" "$DESTDIR/usr/bin/${bin}"
          fi
        done
      fi

      # Install ReGaHss (WebUI binary) - prefer 64-bit from arch-specific directory
      if [ -f "${OCCU_ARCH}/packages-eQ-3/WebUI-Beta/bin/ReGaHss" ]; then
        install -Dm755 "${OCCU_ARCH}/packages-eQ-3/WebUI-Beta/bin/ReGaHss" "$DESTDIR/usr/bin/ReGaHss"
      elif [ -f "${OCCU_COMMON}/packages-eQ-3/WebUI/bin/ReGaHss.community" ]; then
        install -Dm755 "${OCCU_COMMON}/packages-eQ-3/WebUI/bin/ReGaHss.community" "$DESTDIR/usr/bin/ReGaHss"
      fi

      # Install LinuxBasis binaries (64-bit if available)
      if [ -d "${OCCU_ARCH}/packages-eQ-3/LinuxBasis-Beta/bin" ]; then
        for bin in eq3configcmd eq3configd hss_led ssdpd; do
          if [ -f "${OCCU_ARCH}/packages-eQ-3/LinuxBasis-Beta/bin/${bin}" ]; then
            install -Dm755 "${OCCU_ARCH}/packages-eQ-3/LinuxBasis-Beta/bin/${bin}" "$DESTDIR/usr/bin/${bin}"
          fi
        done
      else
        for bin in eq3configcmd eq3configd hss_led ssdpd; do
          if [ -f "${OCCU_COMMON}/packages-eQ-3/LinuxBasis/bin/${bin}" ]; then
            install -Dm755 "${OCCU_COMMON}/packages-eQ-3/LinuxBasis/bin/${bin}" "$DESTDIR/usr/bin/${bin}"
          fi
        done
      fi

      # Install LinuxBasis library
      if [ -d "${OCCU_ARCH}/packages-eQ-3/LinuxBasis-Beta/lib" ]; then
        if [ -f "${OCCU_ARCH}/packages-eQ-3/LinuxBasis-Beta/lib/libeq3config.so" ]; then
          install -Dm755 "${OCCU_ARCH}/packages-eQ-3/LinuxBasis-Beta/lib/libeq3config.so" "$DESTDIR/usr/lib/libeq3config.so"
        fi
      fi

      # Install config templates
      if [ -f "${OCCU_COMMON}/packages-eQ-3/RFD/etc/crRFD_ccu3.conf" ]; then
        install -Dm644 "${OCCU_COMMON}/packages-eQ-3/RFD/etc/crRFD_ccu3.conf" "$DESTDIR/etc/occu/config_templates/crRFD.conf"
        install -Dm644 "${OCCU_COMMON}/packages-eQ-3/RFD/etc/crRFD_ccu3.conf" "$DESTDIR/etc/occu/config_templates/rfd.conf"
      fi

      # Install firmware files to a writable location (not /lib/firmware which may be read-only)
      if [ -d "firmware" ]; then
        cp -r firmware/* "$DESTDIR/usr/share/occu/firmware/" || true
      fi

      # Install Tcl homematic package
      mkdir -p "$DESTDIR/usr/lib/tcl8.6"
      if [ -d "${OCCU_COMMON}/packages-eQ-3/WebUI/lib/tcl8.2/homematic" ]; then
        cp -r "${OCCU_COMMON}/packages-eQ-3/WebUI/lib/tcl8.2/homematic" "$DESTDIR/usr/lib/tcl8.6/"
      fi

  # Install init scripts, config, and utilities
  - runs: |
      DESTDIR="${{targets.destdir}}"

      # Install OpenRC init scripts
      install -Dm755 openccu/occu-rfd.initd "$DESTDIR/etc/init.d/occu-rfd"
      install -Dm644 openccu/occu-rfd.confd "$DESTDIR/etc/conf.d/occu-rfd"
      install -Dm755 openccu/occu-regahss.initd "$DESTDIR/etc/init.d/occu-regahss"
      install -Dm644 openccu/occu-regahss.confd "$DESTDIR/etc/conf.d/occu-regahss"
      install -Dm755 openccu/occu-hmserver.initd "$DESTDIR/etc/init.d/occu-hmserver"
      install -Dm644 openccu/occu-hmserver.confd "$DESTDIR/etc/conf.d/occu-hmserver"

      # Install RF hardware detection script
      install -Dm755 openccu/occu-detect-rf "$DESTDIR/usr/bin/occu-detect-rf"

      # Install Admin user initialization script
      install -Dm755 openccu/occu-init-admin "$DESTDIR/usr/bin/occu-init-admin"

      # Install config templates
      install -Dm644 openccu/crRFD.conf.template "$DESTDIR/etc/occu/config_templates/crRFD.conf"
      install -Dm644 openccu/HMServer.conf.template "$DESTDIR/etc/occu/config_templates/HMServer.conf"

      # Install udev rules
      install -Dm644 openccu/99-occu.rules "$DESTDIR/etc/udev/rules.d/99-occu.rules"

      # Create symlinks for expected paths
      mkdir -p "$DESTDIR/etc/config"
      mkdir -p "$DESTDIR/usr/local/etc"
      ln -sf /etc/occu/config "$DESTDIR/usr/local/etc/config"

      # Create required directories
      mkdir -p "$DESTDIR/var/lib/occu/measurement"
      mkdir -p "$DESTDIR/etc/config/crRFD/data"

      # Install GLIBC C++ runtime libraries for ReGaHss compatibility
      # These provide the compatible libstdc++ and libgcc_s that ReGaHss was compiled against
      mkdir -p "$DESTDIR/usr/lib/openccu/glibc"
      ARCH="$(uname -m)"
      case "$ARCH" in
        aarch64)
          # libstdc++ is in usr/lib/aarch64-linux-gnu, libgcc_s is in lib/aarch64-linux-gnu
          STDCXX_PATH="glibc-libs/usr/lib/aarch64-linux-gnu"
          LIBGCC_PATH="glibc-libs/lib/aarch64-linux-gnu"
          ;;
        x86_64)
          STDCXX_PATH="glibc-libs/usr/lib/x86_64-linux-gnu"
          LIBGCC_PATH="glibc-libs/lib/x86_64-linux-gnu"
          ;;
      esac
      # Copy libstdc++.so.6 (resolve symlinks to get actual files)
      if [ -e "$STDCXX_PATH/libstdc++.so.6" ]; then
        real_lib=$(readlink -f "$STDCXX_PATH/libstdc++.so.6")
        install -Dm755 "$real_lib" "$DESTDIR/usr/lib/openccu/glibc/libstdc++.so.6"
        echo "Installed GLIBC libstdc++.so.6"
      fi
      # Copy libgcc_s.so.1 (resolve symlinks to get actual files)
      if [ -e "$LIBGCC_PATH/libgcc_s.so.1" ]; then
        real_lib=$(readlink -f "$LIBGCC_PATH/libgcc_s.so.1")
        install -Dm755 "$real_lib" "$DESTDIR/usr/lib/openccu/glibc/libgcc_s.so.1"
        echo "Installed GLIBC libgcc_s.so.1"
      fi

subpackages:
  - name: openccu-tclrega
    description: "Tcl extension for ReGaHss communication"
    dependencies:
      runtime:
        - tcl
    pipeline:
      - runs: |
          # Sources are bundled in tclrega/ directory (from OpenCCU project)
          cd tclrega

          # Build xmlParser object (statically linked into tclrega)
          # -fpermissive needed for legacy code (casts NULL to char)
          g++ -c -fPIC -O2 -pipe -fpermissive -Wno-class-memaccess xmlParser.cpp -o xmlParser.o

          # Build tclrega object
          g++ -c -fPIC -O2 -pipe -I. -I/usr/include/tcl8.6 tclrega.cpp -o tclrega.o

          # Link tclrega.so with xmlParser statically included
          g++ -shared -fPIC -o tclrega.so tclrega.o xmlParser.o -ltcl8.6

          # Install to /usr/lib per usrmerge standard
          install -Dm755 tclrega.so "${{targets.contextdir}}/usr/lib/tclrega.so"

  - name: openccu-webui
    description: "eQ-3 OCCU - HomeMatic WebUI"
    dependencies:
      runtime:
        - lighttpd
        - openccu
        - openccu-tclrega
        - tcl
    checks:
      disabled:
        - usrmerge
    scriptlets:
      post-install: |
        #!/bin/sh
        # Create required directories
        mkdir -p /etc/occu/config
        mkdir -p /www/rega

        # Copy templates to config if not exists
        if [ ! -f /etc/occu/config/rega.conf ]; then
          cp /etc/occu/config_templates/rega.conf /etc/occu/config/rega.conf
        fi
        if [ ! -f /etc/occu/config/InterfacesList.xml ]; then
          cp /etc/occu/config_templates/InterfacesList.xml /etc/occu/config/InterfacesList.xml
        fi
        if [ ! -f /etc/occu/config/time.conf ]; then
          cp /etc/occu/config_templates/time.conf /etc/occu/config/time.conf
        fi
        # Create empty regadom file if not exists (ReGaHss will populate it)
        if [ ! -f /etc/occu/config/homematic.regadom ]; then
          touch /etc/occu/config/homematic.regadom
        fi

        # Set up lighttpd with OCCU config
        mkdir -p /var/log/lighttpd
        if [ -f /etc/lighttpd/occu.conf ]; then
          cp /etc/lighttpd/occu.conf /etc/lighttpd/lighttpd.conf
        fi

        echo ""
        echo "=== OCCU WebUI installed ==="
        echo ""
        echo "Start services:"
        echo "  rc-service occu-regahss start"
        echo "  rc-service lighttpd start"
        echo "  rc-update add occu-regahss default"
        echo "  rc-update add lighttpd default"
        echo ""
        echo "Access WebUI:"
        echo "  http://<your-ip>/"
        echo "  Default login: Admin (no password)"
        echo ""
        echo "Ports:"
        echo "  80     WebUI (via lighttpd)"
        echo "  31999  XML-RPC API"
        echo ""
    pipeline:
      - runs: |
          DESTDIR="${{targets.contextdir}}"

          # Create directories
          mkdir -p "$DESTDIR/www"
          mkdir -p "$DESTDIR/etc/lighttpd"
          mkdir -p "$DESTDIR/etc/occu/config_templates"

          # Copy WebUI files - dereference symlinks to avoid broken /opt/hm references
          if [ -d "occu-src/WebUI/www" ]; then
            echo "Copying WebUI files..."
            # First copy with -L to dereference symlinks
            cp -rL occu-src/WebUI/www/* "$DESTDIR/www/" 2>/dev/null || true
            # Remove any remaining broken symlinks
            find "$DESTDIR/www" -xtype l -delete 2>/dev/null || true
          else
            echo "WARNING: occu-src/WebUI/www not found"
          fi

          # Copy Tcl scripts
          if [ -d "occu-src/WebUI/bin" ]; then
            mkdir -p "$DESTDIR/usr/local/bin"
            cp -r occu-src/WebUI/bin/* "$DESTDIR/usr/local/bin/" || true
          fi

          # Copy rega.conf template
          if [ -f "occu-src/WebUI/etc/rega.conf" ]; then
            install -Dm644 occu-src/WebUI/etc/rega.conf "$DESTDIR/etc/occu/rega.conf"
            install -Dm644 occu-src/WebUI/etc/rega.conf "$DESTDIR/etc/occu/config_templates/rega.conf"
          fi

          # Set permissions for CGI files
          find "$DESTDIR/www" -name "*.cgi" -exec chmod 755 {} \; 2>/dev/null || true
          find "$DESTDIR/www" -name "*.ccc" -exec chmod 755 {} \; 2>/dev/null || true

          # Install lighttpd configuration for OCCU WebUI
          install -Dm644 openccu-webui/lighttpd-occu.conf "$DESTDIR/etc/lighttpd/occu.conf"

          # Install simple redirect index.htm (replaces TCL-based one that ReGaHss doesn't process at root)
          install -Dm644 openccu-webui/index.htm "$DESTDIR/www/index.htm"

          # Ensure addons directory exists (symlink target created at runtime)
          mkdir -p "$DESTDIR/www/addons" || true

      # Install configuration templates
      - runs: |
          DESTDIR="${{targets.contextdir}}"

          # Install rega.conf template
          install -Dm644 openccu-webui/rega.conf "$DESTDIR/etc/occu/rega.conf"
          install -Dm644 openccu-webui/rega.conf "$DESTDIR/etc/occu/config_templates/rega.conf"

          # Install InterfacesList.xml template
          install -Dm644 openccu-webui/InterfacesList.xml "$DESTDIR/etc/occu/config_templates/InterfacesList.xml"

          # Install time.conf template
          install -Dm644 openccu-webui/time.conf "$DESTDIR/etc/occu/config_templates/time.conf"

          # Create www/rega directory for ReGaHss HTTP document root
          mkdir -p "$DESTDIR/www/rega"

  - name: openccu-java
    description: "eQ-3 OCCU - HomeMatic IP Server (Java)"
    dependencies:
      runtime:
        - java-jre-headless
        - openccu
        - gcompat-custom
    checks:
      disabled:
        - usrmerge
    scriptlets:
      post-install: |
        #!/bin/sh
        echo ""
        echo "HMIPServer installed. Start with: rc-service occu-hmserver start"
        echo ""
    pipeline:
      - runs: |
          cd occu-src

          DESTDIR="${{targets.contextdir}}"

          # Create directories
          mkdir -p "$DESTDIR/opt/HMServer"
          mkdir -p "$DESTDIR/opt/HmIP"
          mkdir -p "$DESTDIR/etc/occu/config_templates"

          # Install HMServer files
          if [ -d "HMserver/opt/HMServer" ]; then
            cp -r HMserver/opt/HMServer/* "$DESTDIR/opt/HMServer/"
          fi

          # Install HMServer Beta JARs (newer versions)
          if [ -d "HMServer-Beta/opt/HMServer" ]; then
            cp HMServer-Beta/opt/HMServer/*.jar "$DESTDIR/opt/HMServer/" 2>/dev/null || true
          fi

          # Install HmIP files
          if [ -d "HMserver/opt/HmIP" ]; then
            cp -r HMserver/opt/HmIP/* "$DESTDIR/opt/HmIP/"
          fi

          # Install hmip-copro-update.jar from Beta
          if [ -f "HMServer-Beta/opt/HmIP/hmip-copro-update.jar" ]; then
            cp HMServer-Beta/opt/HmIP/hmip-copro-update.jar "$DESTDIR/opt/HmIP/"
          fi

          # Install log4j2 config template
          if [ -f "HMserver/etc/config_templates/log4j2.xml" ]; then
            install -Dm644 HMserver/etc/config_templates/log4j2.xml "$DESTDIR/etc/occu/config_templates/log4j2.xml"
          fi

          # Install HMServer config template
          if [ -f "HMserver/etc/config_templates/HMServer.conf" ]; then
            install -Dm644 HMserver/etc/config_templates/HMServer.conf "$DESTDIR/etc/occu/config_templates/HMServer.conf"
          fi

test:
  environment:
    contents:
      repositories:
        - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
        - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
      keyring:
        - https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-4a6a0840.rsa.pub
      packages:
        - busybox
        - curl
        - gcompat-custom
        - libstdc++
        - libusb
        - lighttpd
        - openjdk21-jre-headless
        - openccu-java
        - openccu-tclrega
        - openccu-webui
        - tcl
        - tzdata
  pipeline:
    - runs: |
        # Test that binaries exist
        test -x /usr/bin/rfd
        test -x /usr/bin/ReGaHss
        test -x /usr/bin/eq3configcmd
        test -x /usr/bin/occu-detect-rf

        # Test that config templates exist
        test -f /etc/occu/config_templates/crRFD.conf
        test -f /etc/occu/config_templates/HMServer.conf

        # Test that udev rules exist
        test -f /etc/udev/rules.d/99-occu.rules

        # Test that gcompat library and loader exist
        test -f /lib/libgcompat.so.0
        test -f /lib/ld-linux.so.2

        # Test that bundled GLIBC C++ runtime libraries exist
        test -f /usr/lib/openccu/glibc/libstdc++.so.6 || {
          echo "ERROR: Bundled GLIBC libstdc++.so.6 not found"
          exit 1
        }
        test -f /usr/lib/openccu/glibc/libgcc_s.so.1 || {
          echo "ERROR: Bundled GLIBC libgcc_s.so.1 not found"
          exit 1
        }
        echo "Bundled GLIBC libraries test passed"

        # Test that eq3configcmd runs with gcompat and produces expected output
        # (gcompat loader is already set up via ld-linux-aarch64.so.1 symlink)
        OUTPUT=$(/usr/bin/eq3configcmd help 2>&1) || true
        echo "$OUTPUT" | grep -q "Supported commands" || {
          echo "ERROR: gcompat test failed - eq3configcmd did not produce expected output"
          echo "Output was: $OUTPUT"
          exit 1
        }
        echo "gcompat test passed: eq3configcmd runs correctly"

        # Test that rfd binary can be executed with gcompat (may fail without hardware but shouldn't crash)
        /usr/bin/rfd --help 2>&1 || true

        # Test tclrega.so exists and can be loaded
        test -f /usr/lib/tclrega.so
        echo "load /usr/lib/tclrega.so" | tclsh 2>&1 || true

        # Test ReGaHss can start (check for segfault)
        echo "Testing ReGaHss startup..."
        mkdir -p /www/rega /etc/occu/config/rc.d /etc/occu/config/addons/www /etc/occu/config/userprofiles
        touch /etc/occu/config/homematic.regadom
        cat > /etc/occu/config/time.conf << 'TIMECONF'
        Longitude=10.0
        Latitude=50.0
        TIMECONF
        cat > /etc/occu/config/InterfacesList.xml << 'IFACES'
        <?xml version="1.0" encoding="ISO-8859-1" ?>
        <interfaces v="1.0">
        </interfaces>
        IFACES
        # Create /etc/localtime and set TZ
        ln -sf /usr/share/zoneinfo/UTC /etc/localtime
        export TZ=UTC

        # Set up environment for ReGaHss
        # - LD_LIBRARY_PATH: bundled GLIBC C++ runtime for RTTI/exception compatibility
        # - LD_PRELOAD: gcompat provides GLIBC syscall compatibility and 2.35+ symbols
        export LD_LIBRARY_PATH="/usr/lib/openccu/glibc${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
        export LD_PRELOAD="/lib/libgcompat.so.0"

        # Test ReGaHss help
        echo "Testing ReGaHss..."
        /usr/bin/ReGaHss --help 2>&1 | grep -q "ReGaHss" && echo "ReGaHss help test passed" || {
          echo "ERROR: ReGaHss --help failed"
          exit 1
        }

        # Test ReGaHss startup with config
        # With bundled GLIBC libstdc++, ReGaHss should no longer crash
        echo "Testing ReGaHss startup with config..."
        timeout 5 /usr/bin/ReGaHss -f /etc/occu/rega.conf -c -l 0 2>&1 || EXITCODE=$?
        if [ "${EXITCODE:-0}" = "139" ] || [ "${EXITCODE:-0}" = "134" ]; then
          echo "ERROR: ReGaHss crashed with segfault (exit code ${EXITCODE:-0})"
          echo "  Bundled GLIBC libraries may not be loading correctly"
          exit 1
        else
          echo "ReGaHss startup test passed (exit code ${EXITCODE:-0})"
        fi

        # Test HMIPServer JAR files exist
        test -f /opt/HMServer/HMIPServer.jar
        test -f /opt/HMServer/HMServer.jar
        test -f /opt/HmIP/hmip-copro-update.jar

        # Test that Java can load the HMIPServer JAR
        JAVA_BIN="/usr/lib/jvm/java-21-openjdk/bin/java"
        test -x "$JAVA_BIN"
        "$JAVA_BIN" -version 2>&1 | grep -q "openjdk" || {
          echo "ERROR: Java version check failed"
          exit 1
        }
        echo "Java test passed"

        # Verify HMIPServer JAR can be loaded (will fail without config but proves JAR integrity)
        "$JAVA_BIN" -jar /opt/HMServer/HMIPServer.jar /nonexistent 2>&1 | grep -q "HMIPServer\|FileNotFoundException" || true
        echo "HMIPServer JAR test passed"

        # Test log4j2 config exists
        test -f /etc/occu/config_templates/log4j2.xml

        # Test openccu-webui: lighttpd config and web files exist
        test -f /etc/lighttpd/occu.conf
        test -d /www
        test -f /www/index.htm

        # Test lighttpd can serve the web UI - use installed config
        mkdir -p /var/log/lighttpd /run/lighttpd /var/lib/lighttpd /var/tmp
        sed 's/server.port = 80/server.port = 8080/; s/server.username/#server.username/; s/server.groupname/#server.groupname/' /etc/lighttpd/occu.conf > /tmp/lighttpd-test.conf

        # Start lighttpd in background
        lighttpd -f /tmp/lighttpd-test.conf
        sleep 1

        # Test that we can fetch a page
        if curl -s -o /tmp/webui-response.html http://127.0.0.1:8080/ ; then
          echo "lighttpd WebUI test passed: Server responded"
        else
          echo "ERROR: lighttpd test failed - could not fetch page"
          exit 1
        fi

        # Stop lighttpd
        pkill lighttpd 2>/dev/null || true

        echo "openccu tests passed!"
