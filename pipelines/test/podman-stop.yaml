name: Stop Podman container service

description: |
  Stops a Podman container service and optionally verifies container cleanup.

  USE THIS PIPELINE WHEN:
  - You need to stop a container service after testing
  - You want to verify a container is properly stopped

  EXAMPLES:

  Example 1 - Simple service stop:
    - uses: test/podman-stop
      with:
        service_name: myapp-container

  Example 2 - With cleanup verification:
    - uses: test/podman-stop
      with:
        service_name: podinfo-container
        verify_container: podinfo

needs:
  packages:
    - openrc

inputs:
  service_name:
    description: |
      The OpenRC service name to stop (e.g., "podinfo-container").
      This is the name used with rc-service commands.
    required: true
  verify_container:
    description: |
      Optional container name to verify is stopped after service stop.
      If specified, the pipeline will fail if the container is still running.
      Example: "podinfo" (for service "podinfo-container")
    required: false

pipeline:
  - name: "Stop OpenRC service"
    runs: |
      set -e

      info() { echo "==> $*"; }
      fail() { echo "ERROR: $*" >&2; exit 1; }

      SERVICE_NAME="${{inputs.service_name}}"

      TMPD=$(mktemp -d)
      trap "rm -rf '$TMPD'" EXIT

      cat > "$TMPD/container_input" <<'MELANGE_CONTAINER_EOF'
      ${{inputs.verify_container}}
      MELANGE_CONTAINER_EOF
      VERIFY_CONTAINER=$(cat "$TMPD/container_input")

      # Check service status before stopping
      info "Current service status:"
      rc-service "$SERVICE_NAME" status || true

      # Stop the service
      info "Stopping service: $SERVICE_NAME"
      if ! rc-service "$SERVICE_NAME" stop; then
        fail "Failed to stop service: $SERVICE_NAME"
      fi

      # Verify container is stopped if requested
      if [ -n "$VERIFY_CONTAINER" ]; then
        info "Verifying container '$VERIFY_CONTAINER' is stopped..."
        sleep 2
        if command -v podman >/dev/null 2>&1; then
          if podman ps --format "{{.Names}}" | grep -q "^${VERIFY_CONTAINER}$"; then
            info "Container status:"
            podman ps -a 2>&1 || true
            fail "Container '$VERIFY_CONTAINER' still running after service stop"
          fi
          info "Container '$VERIFY_CONTAINER' stopped successfully"
        else
          info "Podman not available, skipping container verification"
        fi
      fi

      info "Service $SERVICE_NAME stopped successfully"
