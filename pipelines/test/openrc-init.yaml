name: Initialize OpenRC environment

description: |
  Initializes the OpenRC environment for testing.
  This should be run before any service pipelines (like test/dbus, test/bluetooth).

  Sets up:
  - /run/openrc directory structure
  - Basic rc.conf configuration
  - Marks core services as started (cgroups, net, networking, localmount, hostname, loopback)

needs:
  packages:
    - openrc

pipeline:
  - name: "Initialize OpenRC"
    runs: |
      mkdir -p /run/openrc
      touch /run/openrc/softlevel

      cat > /etc/rc.conf << 'EOF'
      rc_sys="docker"
      rc_controller_cgroups="YES"
      rc_depend_strict="NO"
      rc_provide="loopback net"
      EOF

      touch /etc/fstab

      mkdir -p /etc/network
      cat > /etc/network/interfaces << 'EOF'
      auto lo
      iface lo inet loopback
      EOF

      mkdir -p /etc/runlevels/default

      # Mark required services as "started" so dependencies are satisfied
      mkdir -p /run/openrc/started /run/openrc/starting /run/openrc/inactive
      for svc in cgroups net networking localmount hostname loopback; do
        touch /run/openrc/started/$svc
      done
