#!/sbin/openrc-run

name="otbr-agent"
description="OpenThread Border Router Agent"

command="/usr/sbin/otbr-agent"
command_args="$OTBR_AGENT_OPTS"
command_user="${OTBR_USER:-root}"
pidfile="/run/${RC_SVCNAME}.pid"
command_background=true

depend() {
	need net avahi-daemon
	after firewall
}

start_pre() {
	# Load TUN module if not already loaded
	if [ ! -e /dev/net/tun ]; then
		modprobe tun || {
			eerror "Failed to load TUN module"
			return 1
		}
	fi

	# Load modules for firewall/NAT64 (optional, non-fatal)
	modprobe ip6table_filter 2>/dev/null || true
	modprobe ip6_tables 2>/dev/null || true

	# Enable IP forwarding for border routing
	if [ -f /etc/sysctl.d/otbr.conf ]; then
		sysctl -p /etc/sysctl.d/otbr.conf >/dev/null 2>&1
	else
		# Fallback if sysctl file missing
		sysctl -w net.ipv6.conf.all.forwarding=1 >/dev/null 2>&1
		sysctl -w net.ipv4.ip_forward=1 >/dev/null 2>&1
	fi

	# Ensure radio device exists
	if [ -n "$OTBR_RADIO_DEVICE" ] && [ ! -c "$OTBR_RADIO_DEVICE" ]; then
		eerror "Radio device $OTBR_RADIO_DEVICE not found"
		return 1
	fi

	checkpath --directory --owner "$command_user" /var/lib/otbr
}
