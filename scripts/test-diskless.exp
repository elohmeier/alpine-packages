#!/usr/bin/env expect
# Automated test script for home-assistant-container on diskless Alpine
# Requires: ALPINE_ISO, SD_IMG, PKG_IMG environment variables
#
# This script is called by test-diskless.sh --test

set timeout 60
set boot_timeout 120
set pull_timeout 600

# Track test results
set tests_passed 0
set tests_failed 0

proc log {msg} { puts "\[TEST\] $msg" }
proc pass {msg} {
    global tests_passed
    incr tests_passed
    puts "\[TEST\] PASS: $msg"
}
proc fail {msg} {
    global tests_failed
    incr tests_failed
    puts "\[TEST\] FAIL: $msg"
}

proc run_cmd {cmd} {
    send "$cmd\r"
    expect "# "
}

# Start QEMU
log "Starting QEMU..."
spawn qemu-system-aarch64 \
    -accel hvf \
    -M virt \
    -cpu host \
    -m 8192 \
    -nographic \
    -bios /opt/homebrew/share/qemu/edk2-aarch64-code.fd \
    -drive file=$env(ALPINE_ISO),format=raw,if=virtio,media=cdrom \
    -drive file=$env(SD_IMG),format=raw,if=virtio \
    -drive file=$env(PKG_IMG),format=raw,if=virtio \
    -netdev user,id=net0 \
    -device virtio-net-pci,netdev=net0

# Wait for boot and login
log "Waiting for Alpine to boot..."
expect {
    -timeout $boot_timeout
    "localhost login:" { log "Boot complete" }
    timeout { fail "Boot timeout"; exit 1 }
}

send "root\r"
expect "# "
pass "Login successful"

# Setup networking
log "Setting up network..."
run_cmd "setup-interfaces -a"
run_cmd "ifup eth0"
run_cmd "sleep 2"

# Mount disks FIRST (before package install so post-install detects diskless)
log "Mounting disks..."
run_cmd "mkdir -p /media/mmcblk0p1 /packages"
run_cmd "mount /dev/vdb /media/mmcblk0p1"
run_cmd "mount /dev/vdc /packages"
pass "Disks mounted"

# Setup repositories
log "Configuring repositories..."
run_cmd "setup-apkrepos -1"
# Add community repo for podman dependencies
run_cmd "echo 'http://dl-cdn.alpinelinux.org/alpine/v3.23/community' >> /etc/apk/repositories"
# apk appends /$ARCH to repo path, so use /packages (files are in /packages/aarch64/)
run_cmd "echo '/packages' >> /etc/apk/repositories"
run_cmd "cp /packages/local-melange.rsa.pub /etc/apk/keys/"
run_cmd "apk update"
pass "Repositories configured"

# No additional prerequisites needed - setup script uses tmpfs

# Install package (post-install will detect diskless and setup squashfs)
log "Installing home-assistant-container..."
set timeout 600
send "apk add home-assistant-container; echo XRESULT_INSTALL_\$?\r"
expect {
    -re "\nXRESULT_INSTALL_0\r" { pass "Package installation" }
    -re "\nXRESULT_INSTALL_\[1-9\]" { fail "Package installation" }
    timeout { fail "Package installation (timeout)" }
}
expect "# "

# Verify service files exist
log "Checking service files..."
send "test -x /etc/init.d/home-assistant-container && test -x /etc/init.d/home-assistant-rostore; echo XRESULT_SERVICES_\$?\r"
expect {
    -re "\nXRESULT_SERVICES_0\r" { pass "Service files installed" }
    -re "\nXRESULT_SERVICES_\[1-9\]" { fail "Service files missing" }
    timeout { fail "Service files check (timeout)" }
}
expect "# "

# Verify setup script exists
log "Checking setup script..."
send "test -x /usr/bin/setup-home-assistant-image; echo XRESULT_SETUPEXIST_\$?\r"
expect {
    -re "\nXRESULT_SETUPEXIST_0\r" { pass "Setup script installed" }
    -re "\nXRESULT_SETUPEXIST_\[1-9\]" { fail "Setup script missing" }
    timeout { fail "Setup script check (timeout)" }
}
expect "# "

# Run setup script manually (post-install may not have run it due to timing)
log "Running setup script manually (this will pull ~1GB container image)..."
set timeout $pull_timeout
send "/usr/bin/setup-home-assistant-image 2>&1; echo XRESULT_SETUP_\$?\r"
expect {
    -re "\nXRESULT_SETUP_0\r" { pass "Setup script completed" }
    -re "\nXRESULT_SETUP_\[1-9\]" { fail "Setup script failed" }
    timeout { fail "Setup script (timeout)" }
}
expect "# "

# Verify squashfs created
log "Checking squashfs image..."
set timeout 60
send "test -f /media/mmcblk0p1/home-assistant-image.squashfs; echo XRESULT_SQUASHFS_\$?\r"
expect {
    -re "\nXRESULT_SQUASHFS_0\r" { pass "Squashfs image created" }
    -re "\nXRESULT_SQUASHFS_\[1-9\]" { fail "Squashfs image not found" }
    timeout { fail "Squashfs check (timeout)" }
}
expect "# "

# Check rostore service status (may already be started by post-install)
log "Checking rostore service..."
send "rc-service home-assistant-rostore status >/dev/null 2>&1; echo XRESULT_ROSTORE_\$?\r"
expect {
    -re "\nXRESULT_ROSTORE_0\r" { pass "Rostore service running" }
    -re "\nXRESULT_ROSTORE_\[1-9\]" { fail "Rostore service not running" }
    timeout { fail "Rostore check (timeout)" }
}
expect "# "

# Check container image available via rostore
log "Checking container image via rostore..."
send "podman images 2>/dev/null | grep -q home-assistant; echo XRESULT_IMAGE_\$?\r"
expect {
    -re "\nXRESULT_IMAGE_0\r" { pass "Container image available" }
    -re "\nXRESULT_IMAGE_\[1-9\]" { fail "Container image not available" }
    timeout { fail "Container image check (timeout)" }
}
expect "# "

# Start container service
log "Starting container service..."
set timeout 120
send "rc-service home-assistant-container start 2>&1; echo XRESULT_START_\$?\r"
expect {
    -re "\nXRESULT_START_0\r" { pass "Container service started" }
    -re "\nXRESULT_START_\[1-9\]" { fail "Container service start failed" }
    timeout { fail "Container start (timeout)" }
}
expect "# "

# Wait for container to be ready using shell sleep with XRESULT pattern
log "Waiting 15 seconds for container startup..."
set timeout 45
send "sleep 15; echo XRESULT_SLEEP_DONE\r"
expect {
    -re "\nXRESULT_SLEEP_DONE\r" { log "Container startup wait complete" }
    timeout { log "Sleep command timeout" }
}
expect "# "

# Check container running
log "Verifying container running..."
set timeout 60
send "podman ps 2>/dev/null | grep -q home-assistant; echo XRESULT_RUNNING_\$?\r"
expect {
    -re "\nXRESULT_RUNNING_0\r" { pass "Container running" }
    -re "\nXRESULT_RUNNING_\[1-9\]" { fail "Container not running" }
    timeout { fail "Container running check (timeout)" }
}
expect "# "

# Test upgrade mechanism
log "Testing upgrade mechanism (this will re-pull ~1GB container image)..."
log "Stopping container service..."
set timeout 60
send "rc-service home-assistant-container stop 2>&1; echo XRESULT_STOP1_\$?\r"
expect {
    -re "\nXRESULT_STOP1_0\r" { log "Container service stopped" }
    -re "\nXRESULT_STOP1_\[1-9\]" { log "Container service stop returned non-zero (may be ok)" }
    timeout { log "Container stop timeout (continuing anyway)" }
}
expect "# "
send "rc-service home-assistant-rostore stop 2>&1; echo XRESULT_STOP2_\$?\r"
expect {
    -re "\nXRESULT_STOP2_0\r" { log "Rostore service stopped" }
    -re "\nXRESULT_STOP2_\[1-9\]" { log "Rostore service stop returned non-zero (may be ok)" }
    timeout { log "Rostore stop timeout (continuing anyway)" }
}
expect "# "
set timeout $pull_timeout
send "/usr/bin/setup-home-assistant-image --upgrade 2>&1; echo XRESULT_UPGRADE_\$?\r"
expect {
    -re "\nXRESULT_UPGRADE_0\r" { pass "Upgrade script completed" }
    -re "\nXRESULT_UPGRADE_\[1-9\]" { fail "Upgrade script failed" }
    timeout { fail "Upgrade (timeout after 10 min)" }
}
expect "# "

# Final verification after upgrade
log "Verifying post-upgrade state..."
set timeout 60
send "test -f /media/mmcblk0p1/home-assistant-image.squashfs; echo XRESULT_FINAL_\$?\r"
expect {
    -re "\nXRESULT_FINAL_0\r" { pass "Post-upgrade squashfs exists" }
    -re "\nXRESULT_FINAL_\[1-9\]" { fail "Post-upgrade squashfs missing" }
    timeout { fail "Final check (timeout)" }
}
expect "# "

# Summary
puts ""
puts "========================================"
puts "\[TEST\] SUMMARY: $tests_passed passed, $tests_failed failed"
puts "========================================"

# Shutdown
log "Shutting down VM..."
send "poweroff\r"
expect eof

# Exit with appropriate code
if {$tests_failed > 0} {
    exit 1
} else {
    exit 0
}
